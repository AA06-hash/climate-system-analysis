{% extends "base.html" %}
{% block title %}My Profile{% endblock %}

{% block content %}
<div class="page-wrap">

  <div class="page-header">
    <div class="page-header-left">
      <div class="eyebrow">Account</div>
      <h2>My Profile</h2>
    </div>
    <a href="/dashboard" class="btn btn-outline">← Dashboard</a>
  </div>

  <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px; align-items:start">

    <!-- ── Left column ── -->
    <div style="display:flex; flex-direction:column; gap:24px">

      <!-- Profile card -->
      <div class="card">
        <div style="display:flex; align-items:center; gap:20px; margin-bottom:24px; padding-bottom:20px; border-bottom:1px solid var(--border)">
          <div style="width:60px; height:60px; border-radius:50%;
                      background:linear-gradient(135deg,#1e6fff,#00c9a7);
                      display:flex; align-items:center; justify-content:center;
                      font-size:1.5rem; font-weight:700; color:#fff; flex-shrink:0">
            {{ user_data.name[0].upper() }}
          </div>
          <div>
            <div style="font-size:1.1rem; font-weight:700; color:var(--text)">{{ user_data.name }}</div>
            <div style="font-size:.8rem; color:var(--text-muted)">{{ user_data.email }}</div>
            <span class="badge badge-{{ user_data.role }}" style="margin-top:6px; display:inline-block">
              {{ user_data.role }}
            </span>
          </div>
        </div>

        <!-- Quick stats -->
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px">
          <div style="background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius); padding:14px">
            <div class="stat-label">Total DB Records</div>
            <div style="font-size:1.5rem; font-weight:700; font-family:var(--font-mono); color:var(--text)">
              {{ db_stats.total }}
            </div>
          </div>
          <div style="background:var(--bg-input); border:1px solid var(--border); border-radius:var(--radius); padding:14px">
            <div class="stat-label">Account Role</div>
            <div style="font-size:1.5rem; font-weight:700; font-family:var(--font-mono); color:var(--text); text-transform:capitalize">
              {{ user_data.role }}
            </div>
          </div>
        </div>
      </div>

      <!-- Update info form -->
      <div class="card">
        <h3 style="margin-bottom:20px">Update Info</h3>
        <form method="POST" action="/profile">
          <input type="hidden" name="action" value="update_info">
          <div style="display:flex; flex-direction:column; gap:16px">
            <div class="form-group">
              <label for="name">Full Name</label>
              <input type="text" id="name" name="name"
                     value="{{ user_data.name }}" required>
            </div>
            <div class="form-group">
              <label for="email">Email Address</label>
              <input type="email" id="email" name="email"
                     value="{{ user_data.email }}" required>
            </div>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Save Changes →</button>
          </div>
        </form>
      </div>

    </div>

    <!-- ── Right column: Change password ── -->
    <div class="card">
      <h3 style="margin-bottom:8px">Change Password</h3>
      <p style="font-size:.8rem; color:var(--text-muted); margin-bottom:24px; line-height:1.6">
        Choose a strong password. It must be at least 6 characters long.
      </p>

      <form method="POST" action="/profile">
        <input type="hidden" name="action" value="change_password">
        <div style="display:flex; flex-direction:column; gap:16px">

          <div class="form-group">
            <label for="current_password">Current Password</label>
            <input type="password" id="current_password" name="current_password"
                   placeholder="Enter current password" required>
          </div>

          <div class="form-group">
            <label for="new_password">New Password</label>
            <input type="password" id="new_password" name="new_password"
                   placeholder="Min. 6 characters" required>
          </div>

          <div class="form-group">
            <label for="confirm_password">Confirm New Password</label>
            <input type="password" id="confirm_password" name="confirm_password"
                   placeholder="Repeat new password" required>
          </div>

        </div>

        <!-- Password strength indicator -->
        <div style="margin-top:16px">
          <div style="font-size:.65rem; letter-spacing:.15em; text-transform:uppercase;
                      color:var(--text-muted); margin-bottom:6px">Password Strength</div>
          <div id="strength-bar" style="height:4px; border-radius:2px; background:var(--border);
                                        transition:all .3s; width:0%"></div>
          <div id="strength-text" style="font-size:.72rem; color:var(--text-dim); margin-top:4px"></div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Update Password →</button>
        </div>
      </form>
    </div>

  </div>
</div>

<script>
  // Live password strength indicator
  const pw = document.getElementById('new_password');
  const bar = document.getElementById('strength-bar');
  const txt = document.getElementById('strength-text');

  pw.addEventListener('input', () => {
    const v = pw.value;
    let score = 0;
    if (v.length >= 6)  score++;
    if (v.length >= 10) score++;
    if (/[A-Z]/.test(v)) score++;
    if (/[0-9]/.test(v)) score++;
    if (/[^A-Za-z0-9]/.test(v)) score++;

    const levels = [
      { w:'0%',   c:'var(--border)',   t:'' },
      { w:'25%',  c:'var(--danger)',   t:'Weak' },
      { w:'50%',  c:'var(--warn)',     t:'Fair' },
      { w:'75%',  c:'#aad44f',        t:'Good' },
      { w:'100%', c:'var(--success)', t:'Strong' },
    ];
    const l = levels[Math.min(score, 4)];
    bar.style.width      = l.w;
    bar.style.background = l.c;
    txt.style.color      = l.c;
    txt.textContent      = l.t;
  });
</script>
{% endblock %}